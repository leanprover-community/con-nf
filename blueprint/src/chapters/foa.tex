\section{Base approximations}
\begin{definition}[base approximation]
  \label{def:BaseApprox}
  \uses{def:NearLitter}
  \lean{ConNF.BaseApprox}
  \leanok
  A \emph{base approximation} is a pair \( \psi = (\psi^{E\Atom}, \psi^\Litter) \) such that \( \psi^{E\Atom} \) and \( \psi^\Litter \) are permutative relations of atoms and litters respectively (\cref{def:relation_props}), and for each litter \( L \), the set
  \[ \LS(L) \cap \coim \psi^{E\Atom} \]
  is small.
  The relation \( \psi^{E\Atom} \) is called the \emph{exceptional atom graph}, and \( \psi^\Litter \) is called the \emph{litter graph}.
  We make the following definitions.
  \begin{itemize}
    \item The \emph{inverse} of a base approximation is \( \psi^{-1} = ((\psi^{E\Atom})^{-1}, (\psi^\Litter)^{-1}) \).
    \item If \( \psi \) and \( \chi \) are base approximations where \( \coim \psi^{E\Atom} = \coim \chi^{E\Atom} \) and \( \coim \psi^\Litter = \coim \chi^\Litter \), then their \emph{composition} \( \psi \circ \chi \) is the base approximation \( (\psi^{E\Atom} \circ \chi^{E\Atom}, \psi^\Litter \circ \chi^\Litter) \).
    \item The \emph{\( \psi \)-sublitter} of a litter \( L \), written \( L_\psi \), is the near-litter \( (L, \LS(L) \setminus \coim \psi^{E\Atom}) \).
  \end{itemize}
\end{definition}
\begin{definition}[atom graph of an approximation]
  \uses{def:BaseApprox}
  \label{def:atomGraph}
  \lean{ConNF.BaseApprox.atoms}
  \leanok
  The \emph{typical atom graph} of \( \psi \) is the relation \( \psi^{T\Atom} \) given by the following constructor.
  If \( (L_1, L_2) \in \psi^\Litter \), then
  \[ (h_{(L_1)_\psi}(i), h_{(L_2)_\psi}(i)) \in \psi^{T\Atom} \]
  for some \( i : \kappa \), where for any near-litter \( N \), \( h_N \) is an equivalence \( \kappa \simeq N \) chosen in advance.

  The \emph{atom graph} of \( \psi \) is the relation \( \psi^\Atom = \psi^{E\Atom} \sqcup \psi^{T\Atom} \): the join of the exceptional and typical atom graphs.
\end{definition}
\begin{proposition}
  \uses{def:atomGraph}
  \label{prop:atomGraph_inv}
  \lean{ConNF.BaseApprox.instInv}
  \leanok
  \( (\psi^{T\Atom})^{-1} = (\psi^{-1})^{T\Atom} \) and hence \( (\psi^\Atom)^{-1} = (\psi^{-1})^\Atom \).
\end{proposition}
\begin{proof}
  \leanok
  This follows directly from the fact that \( L_\psi = L_{\psi^{-1}} \) for any litter \( L \).
\end{proof}
\begin{proposition}
  \uses{def:atomGraph}
  \label{prop:atomGraph_permutative}
  \lean{ConNF.BaseApprox.typical_permutative,ConNF.BaseApprox.atoms_permutative}
  \leanok
  The graphs \( \psi^{T\Atom} \) and \( \psi^\Atom \) are permutative.
\end{proposition}
\begin{proof}
  \uses{prop:atomGraph_inv}
  \leanok
  The typical atom graph is injective, because the equation \( h_{L_\psi}(i)^\circ = L \) can be used to establish the the parameters of the relevant \( h \) maps coincide.
  Furthermore, we can use the fact that \( \psi^\Litter \) has equal image and coimage to produce images of any image element of this relation.
  We then appeal to symmetry using \cref{prop:atomGraph_inv} to conclude that \( \psi^{T\Atom} \) is permutative.

  The (co)image of \( \psi^{T\Atom} \) is
  \[ \bigcup_{L \in \coim \psi^\Litter} L_\psi = \bigcup_{L \in \coim \psi^\Litter} (\LS(L) \setminus \coim \psi^{E\Atom}) \]
  which is clearly disjoint from the coimage of \( \psi^{E\Atom} \).\footnote{This result should of course be its own lemma.}
  So \( \psi^\Atom \) is permutative by one of the results of \cref{prop:relation_results}.
\end{proof}
\begin{proposition}
  \uses{def:atomGraph}
  \label{prop:comp_atomGraph}
  If \( \psi, \chi \) have equal exceptional atom and litter coimages, then \( (\psi \circ \chi)^{T\Atom} = \psi^{T\Atom} \circ \chi^{T\Atom} \).
\end{proposition}
\begin{proof}
  Suppose that \( (a_1, a_3) \in (\psi \circ \chi)^{T\Atom} \), so
  \[ a_1 = h_{(L_1)_{\psi \circ \chi}}(i);\quad a_3 = h_{(L_3)_{\psi \circ \chi}}(i);\quad (L_1, L_3) \in (\psi \circ \chi)^\Litter \]
  Since \( (\psi \circ \chi)^\Litter = \psi^\Litter \circ \chi^\Litter \), there is \( L_2 \) such that \( (L_1, L_2) \in \chi^\Litter \) and \( (L_2, L_3) \in \psi^\Litter \).
  Hence
  \[ (h_{(L_1)_\chi}(i), h_{(L_2)_\chi}(i)) \in \chi^{T\Atom};\quad (h_{(L_2)_\psi}(i), h_{(L_3)_\psi}(i)) \in \psi^{T\Atom} \]
  But \( L_{\psi \circ \chi} = L_\psi = L_\chi \), so we obtain
  \[ (a_1, h_{(L_2)_\chi}(i)) \in \chi^{T\Atom};\quad (h_{(L_2)_\chi}(i), a_3) \in \psi^{T\Atom} \]
  For the converse, suppose that \( (a_1, a_2) \in \chi^{T\Atom} \) and \( (a_2, a_3) \in \psi^{T\Atom} \).
  Then
  \[ a_1 = h_{(L_1)_\chi}(i);\quad a_2 = h_{(L_2)_\chi}(i);\quad a_2 = h_{(L_2')_\psi}(j);\quad a_3 = h_{(L_3)_\psi}(j) \]
  We obtain \( L_2 = L_2' \), and \( (L_2)_\chi = (L_2)_\psi \) so we also conclude \( i = j \).
  Since \( (L_1, L_2) \in \chi^\Litter \) and \( (L_2, L_3) \in \psi^\Litter \), we conclude \( (L_1, L_3) \in (\psi \circ \chi)^\Litter \), as required.
\end{proof}
\begin{definition}[near-litter graph of an approximation]
  \uses{def:atomGraph}
  \label{def:nearLitterGraph}
  \lean{ConNF.BaseApprox.nearLitters}
  \leanok
  The \emph{near-litter graph} of \( \psi \) is the relation \( \psi^\NearLitter \) given by setting \( (N_1, N_2) \in \psi^\NearLitter \) if and only if \( (N_1^\circ, N_2^\circ) \in \psi^\Litter \), \( N_1 \) and \( N_2 \) are subsets of \( \coim \psi^\Atom \), and the image of \( \psi^\Atom \) on \( N_1 \) is \( N_2 \) (or equivalently, by \cref{prop:relation_results}, the coimage of \( \psi^\Atom \) on \( N_2 \) is \( N_1 \)).
\end{definition}
\begin{proposition}
  \uses{def:nearLitterGraph}
  \label{prop:approx_near}
  \lean{ConNF.BaseApprox.image_near_of_near}
  \leanok
  Let \( s \) be a set of atoms near \( \LS(L) \) for some litter \( L \).
  If \( (L, L') \in \psi^\Litter \), then the image of \( \psi^\Atom \) on \( s \) is near \( \LS(L') \).
\end{proposition}
\begin{proof}
  \leanok
  We calculate
  \begin{align*}
    \im \psi^\Atom|_s
    &= \im \psi^\Atom|_{\LS(L)} \symmdiff \im \psi^\Atom|_{s \symmdiff \LS(L)} \\
    &\near \im \psi^\Atom|_{\LS(L)} \\
    &= \im \psi^\Atom|_{\LS(L) \setminus \coim \psi^{E\Atom}} \cup \im \psi^\Atom|_{\LS(L) \cap \coim \psi^{E\Atom}} \\
    &\near \im \psi^\Atom|_{\LS(L) \setminus \coim \psi^{E\Atom}} \\
    &= \im \psi^{T\Atom}|_{L_\psi} \\
    &= L'_\psi \\
    &\near \LS(L')
  \end{align*}
\end{proof}
\begin{proposition}
  \uses{def:nearLitterGraph}
  \label{prop:nearLitterGraph_permutative}
  \lean{ConNF.BaseApprox.inv_nearLitters,ConNF.BaseApprox.nearLitters_permutative}
  \leanok
  \( (\psi^{-1})^\NearLitter = (\psi^\NearLitter)^{-1} \), and \( \psi^\NearLitter \) is permutative.
\end{proposition}
\begin{proof}
  \uses{prop:atomGraph_permutative,prop:approx_near}
  \leanok
  The first part follows from \cref{prop:atomGraph_inv}.
  To show \( \psi^\NearLitter \) is permutative, it suffices to show that it is injective and that its image is contained in its coimage; then, by taking inverses, the converses will also hold.
  Suppose that \( (N_1, N_3), (N_2, N_3) \in \psi^\NearLitter \).
  Then the coimage of \( \psi^\Atom \) on \( N_3 \) is equal to both \( N_1 \) and \( N_2 \), so \( N_1 = N_2 \), giving injectivity.

  Now suppose that \( (N_1, N_2) \in \psi^\NearLitter \).
  As \( (N_1^\circ, N_2^\circ) \in \psi^\Litter \), we must have \( (N_2^\circ, L) \in \psi^\Litter \) for some \( L \).
  By \cref{prop:approx_near}, the image \( s \) of \( \psi^\Atom \) on \( N_2 \) is near \( \LS(L) \), so \( (L, s) \) is a near-litter, and \( (N_2, (L, s)) \in \psi^\NearLitter \) as required.
\end{proof}
\begin{definition}
  \uses{def:nearLitterGraph}
  \label{def:smulApproxSupport}
  Base approximations act on base supports in the following way.
  If \( S^\Atom = (i, f) \), then \( \psi(S)^\Atom = (i, f') \) where
  \[ f' = \{ (j, a_2) \mid (j, a_1) \in f \wedge (a_1, a_2) \in \psi^\Atom \} \]
  The same definition is used for near-litters.
\end{definition}

\section{Extensions of approximations}
\begin{definition}
  \uses{def:BaseApprox}
  \label{def:BaseApprox.LE}
  \lean{ConNF.BaseApprox.instPartialOrder}
  \leanok
  We define a partial order on base approximations by setting \( \psi \leq \chi \) when \( \psi^{E\Atom} = \chi^{E\Atom} \) and \( \psi^\Litter \leq \chi^\Litter \).
\end{definition}
\begin{proposition}[adding orbits]
  \uses{def:BaseApprox.LE}
  \label{prop:BaseApprox.addOrbit}
  \lean{ConNF.BaseApprox.addOrbit}
  \leanok
  Let \( \psi \) be a base approximation, and let \( L : \mathbb N \to \Litter \) be a function such that
  \[ L(m) = L(n) \to L(m+k) = L(n+k) \]
  for all integers \( m, n, k : \mathbb Z \).
  Suppose that for all \( n \), \( L(n) \notin \coim \psi^\Litter \).
  Then there is an extension \( \chi \geq \psi \) such that \( \chi^\Litter(L(n)) = L(n+1) \) and \( \coim \chi^\Litter = \coim \psi^\Litter \cup \ran L \).
\end{proposition}
\begin{proof}
  \leanok
  Define the relation
  \[ R = \{ (L(n), L(n+1)) \mid n : \mathbb Z \} \]
  This clearly has equal image and coimage.
  It is injective: if \( (L_1, L_3), (L_2, L_3) \in R \), then there are \( m, n : \mathbb Z \) such that
  \[ L_1 = L(m);\quad L_3 = L(m + 1);\quad L_2 = L(n);\quad L_3 = L(n + 1) \]
  So \( L(m + 1) = L(n + 1) \), giving \( L_1 = L(m) = L(n) = L_2 \) by substituting \( k = -1 \) in the hypothesis.
  It is also coinjective by substituting \( k = 1 \) in the hypothesis.
  So \( R \) is permutative.
  Therefore, \( \psi^\Litter \sqcup R \) is a permutative relation, so \( (\psi^{E\Atom}, \psi^\Litter \sqcup R) \) is an extension of \( \psi \), and it clearly satisfies the result.
\end{proof}

\section{Structural approximations}
\begin{definition}
  \uses{def:BaseApprox.LE,def:Tree}
  \label{def:StrApprox}
  \lean{ConNF.StrApprox}
  \leanok
  For a type index \( \beta \), a \emph{\( \beta \)-approximation} is a \( \beta \)-tree of base approximations.
  We define the partial order on \( \beta \)-approximations branchwise.
  We define an action of \( \beta \)-approximations \( \psi \) on \( \beta \)-supports \( S \) by \( (\psi(S))_A = \psi_A(S_A) \).
\end{definition}
\begin{definition}
  \uses{def:InflexiblePath}
  \label{def:Inflexible}
  \lean{ConNF.Inflexible}
  \leanok
  Let \( A \) be a \( \beta \)-extended type index.
  A litter \( L \) is \emph{\( A \)-inflexible} if there is an inflexible \( \beta \)-path \( I \) such that \( A = ((A_I)_{\varepsilon_I})_\bot \) and \( L = f_{\delta_I, \varepsilon_I}(t) \) for some \( t : \Tang_{\delta_I} \).
  The coderivative operation works in the obvious way.
  A litter can be \( A \)-inflexible in at most one way.\footnote{We should make \( A \)-inflexibility into a subsingleton structure.}

  We say that a \( L \) is \emph{\( A \)-flexible} if it is not \( A \)-inflexible.\footnote{This is not data, but a proposition.}
  If \( L \) is \( B_A \)-flexible, then \( L \) is \( A \)-flexible.
\end{definition}
\begin{definition}
  \uses{def:StrApprox,def:Inflexible,def:smulApproxSupport}
  \label{def:StrApprox.Coherent}
  \lean{ConNF.StrApprox.CoherentAt,ConNF.StrApprox.Coherent}
  \leanok
  A \( \beta \)-approximation \( \psi \) is \emph{coherent} at \( (A, L_1, L_2) \) if:
  \begin{itemize}
    \item If \( L_1 \) is \( A \)-inflexible with inflexible \( \beta \)-path \( I = (\gamma, \delta, \varepsilon, B) \) and tangle \( t : \Tang_\delta \), then there is some \( \delta \)-allowable permutation \( \rho \) such that
    \[ (\psi_B)_\delta(\supp(t)) = \rho(\supp(t)) \]
    and
    \[ L_2 = f_{\delta,\varepsilon}(\rho(t)) \]
    (and hence all \( \delta \)-allowable permutations \( \rho \) such that \( (\psi_B)_\delta(\supp(t)) = \rho(\supp(t)) \) satisfy \( L_2 = f_{\delta,\varepsilon}(\rho(t)) \)).
    \item If \( L_1 \) is \( A \)-flexible, then \( L_2 \) is \( A \)-flexible.
  \end{itemize}
  We say that \( \psi \) is \emph{coherent} if whenever \( (L_1, L_2) \in \psi_A^\Litter \), \( \psi \) is coherent at \( (A, L_1, L_2) \).
\end{definition}
\begin{proposition}[adding orbits coherently]
  \uses{prop:BaseApprox.addOrbit,def:StrApprox.Coherent}
  \label{prop:StrApprox.addOrbit}
  \lean{ConNF.StrApprox.addOrbit_coherent}
  \leanok
  Suppose that \( \psi \) is an approximation and \( L : \mathbb Z \to \Litter \) is a function satisfying the hypotheses of \cref{prop:BaseApprox.addOrbit}.
  Let \( \chi \) be the extension produced by the structural version of this result.\footnote{We need the extension exactly as produced (as data), not an arbitrary extension satisfying the conclusion of the proposition.}
  If \( \psi \) is coherent, and is additionally coherent at \( (L(n), L(n+1)) \) for each integer \( n \), then \( \chi \) is coherent.
\end{proposition}
\begin{proof}
  \leanok
  This proof just relies on the fact that if \( (\psi_B)_\delta(\supp(t)) = \rho(\supp(t)) \), then the same holds for every extension \( \chi \) of \( \psi \).\footnote{Maybe there's a better lemma to abstract out this idea for this and \cref{prop:StrApprox.chain}?}
\end{proof}
\begin{proposition}
  \uses{def:StrApprox.Coherent}
  \label{prop:StrApprox.Coherent.inv}
  If \( \psi \) is coherent, then \( \psi^{-1} \) is coherent.
\end{proposition}
\begin{proof}
  Suppose that \( (L_1, L_2) \in (\psi^{-1}_A)^\Litter \), so \( (L_2, L_1) \in \psi_A^\Litter \).
  Suppose first that \( L_1 \) is \( A \)-inflexible with inflexible \( \beta \)-path \( I = (\gamma, \delta, \varepsilon, B) \) and tangle \( t : \Tang_\delta \).
  If \( L_2 \) were \( A \)-flexible, then \( L_1 \) would also be \( A \)-flexible by coherence, which is a contradiction.
  So \( L_2 \) is \( A \)-inflexible with path \( (\gamma', \delta', \varepsilon', B') \) and tangle \( t' : \Tang_{\delta'} \), and there is \( \rho : \AllPerm_{\delta'} \) such that
  \[ (\psi_{B'})_{\delta'}(\supp(t')) = \rho(\supp(t')) \]
  and
  \[ A = (B_{\varepsilon'})_\bot;\quad L_2 = f_{\delta',\varepsilon'}(t');\quad L_1 = f_{\delta',\varepsilon'}(\rho(t')) \]
  We thus deduce \( \varepsilon = \varepsilon' \) and \( \gamma = \gamma' \) by the equations for \( A \).
  By the equation \( L_1 = f_{\delta,\varepsilon}(t) \), we also obtain \( \delta = \delta' \) and \( t = \rho(t') \).
  Then we find
  \begin{align*}
    (\psi_B)_\delta(\supp(\rho^{-1}(t))) &= \rho(\supp(\rho^{-1}(t))) \\
    (\psi_B)_\delta(\rho^{-1}(\supp(t))) &= \rho(\rho^{-1}(\supp(t))) \\
    (\psi_B)_\delta(\rho^{-1}(\supp(t))) &= \supp(t) \\
    \rho^{-1}(\supp(t)) &= (\psi^{-1}_B)_\delta(\supp(t))
  \end{align*}
  where the last equation uses the fact that \( (\psi_B)_\delta \) is defined on all of \( \supp(t') \).
  Finally, the equation \( L_2 = f_{\delta,\varepsilon}(\rho^{-1}(t)) \) gives coherence at \( (A, L_1, L_2) \) as required.

  Now suppose that \( L_1 \) is \( A \)-flexible.
  If \( L_2 \) were \( A \)-inflexible, then so would be \( L_1 \) by coherence.
  So \( L_2 \) is \( A \)-flexible, as required.
\end{proof}
\begin{proposition}
  \uses{def:StrApprox.Coherent}
  \label{prop:StrApprox.Coherent.comp}
  If \( \psi \) and \( \chi \) are coherent and have equal coimages along all paths, then \( \psi \circ \chi \) is coherent.
\end{proposition}
\begin{proof}
  Suppose that \( (L_1, L_3) \in ((\psi \circ \chi)_A)^\Litter \), so \( (L_1, L_2) \in \psi_A^\Litter \) and \( (L_2, L_3) \in \chi_A^\Litter \).
  Suppose that \( L_1 \) is \( A \)-inflexible with inflexible \( \beta \)-path \( I = (\gamma, \delta, \varepsilon, B) \) and tangle \( t : \Tang_\delta \).
  Then by coherence of \( \psi \), we have \( \rho \) such that
  \[ (\psi_B)_\delta(\supp(t)) = \rho(\supp(t)) \]
  and
  \[ L_2 = f_{\delta,\varepsilon}(\rho(t)) \]
  Then \( L_2 \) is \( A \)-inflexible with path \( I \) and tangle \( \rho(t) \).
  So by coherence of \( \chi \), we have \( \rho' \) such that
  \[ (\psi_B)_\delta(\supp(\rho(t))) = \rho'(\supp(\rho(t))) \]
  and
  \[ L_3 = f_{\delta,\varepsilon}(\rho'(\rho(t))) \]
  As \( \rho'(\supp(\rho(t))) = \rho'(\rho(\supp(t))) \), we obtain the desired coherence result.

  Instead, if \( L_1 \) is \( A \)-flexible, then so is \( L_2 \) by coherence of \( \psi \), and so is \( L_3 \) by coherence of \( \chi \).
\end{proof}
\begin{proposition}
  \uses{def:StrApprox.Coherent}
  \label{prop:StrApprox.Coherent.deriv}
  If \( \psi \) is a coherent \( \beta \)-approximation and \( A \) is a path \( \beta \tpath \beta' \), then \( \psi_A \) is a coherent \( \beta' \)-approximation.
\end{proposition}
\begin{proof}
  \uses{prop:StrApprox.Coherent.inv}
  Let \( (L_1, L_2) \in (\psi_A)_B^\Litter \).
  Suppose that \( L_1 \) is \( B \)-inflexible with path \( (\gamma, \delta, \varepsilon, C) \) and \( t : \Tang_\delta \).
  Then \( L_1 \) is \( A_B \)-inflexible with path \( (\gamma, \delta, \varepsilon, A_C) \) and the same tangle \( t \).
  So by coherence of \( \psi \), we obtain a \( \delta \)-allowable \( \rho \) such that
  \[ (\psi_{(A_C)})_\delta(\supp(t)) = \rho(\supp(t)) \]
  and
  \[ L_2 = f_{\delta,\varepsilon}(\rho(t)) \]
  This same \( \rho \) can thus be used to establish coherence of \( \psi_A \) at \( (B, L_1, L_2) \).

  Thus, by \cref{prop:StrApprox.Coherent.inv}, whenever \( L_2 \) is \( B \)-inflexible with path \( I \) and tangle \( t \), \( L_1 \) is also \( B \)-inflexible with path \( I \).
  So if \( L_1 \) is \( B \)-flexible, so is \( L_2 \), as required.
\end{proof}

\section{Proving freedom of action}
\begin{definition}[approximates]
  \uses{def:StrApprox,def:atomGraph,prop:atomGraph_inv,prop:comp_atomGraph,prop:nearLitterGraph_permutative}
  \label{def:StrApprox.Approximates}
  \lean{ConNF.StrApprox.Approximates}
  \leanok
  We say that a \( \beta \)-approximation \( \psi \) \emph{approximates} a \( \beta \)-allowable permutation \( \rho \) if \( \psi_A^\Litter \leq \rho_A^\Litter \) and \( \psi_A^\Atom \leq \rho_A^\Atom \) for each path \( A : \beta \tpath \bot \).
  If \( \psi \) approximates \( \rho \) then \( \psi^n \) approximates \( \rho^n \) for each \( n : \mathbb Z \).\footnote{We should define what it means for a base approximation to approximate a near-litter permutation, and define this in terms of that.}
  A \( \beta \)-approximation \( \psi \) \emph{exactly approximates} a \( \beta \)-allowable permutation \( \rho \) if \( \psi \) approximates \( \rho \), and in addition, if \( a \) is an atom and \( A : \beta \tpath \bot \), then \( a \notin \coim \psi_A^\Atom \) implies \( \rho(a)^\circ = \rho(a^\circ) \) and \( \rho^{-1}(a)^\circ = \rho^{-1}(a^\circ) \).
\end{definition}
\begin{definition}[freedom of action]
  \uses{def:StrApprox.Approximates}
  \label{def:FreedomOfAction}
  \lean{ConNF.StrApprox.FreedomOfAction}
  \leanok
  We say that \emph{freedom of action} holds at a type index \( \delta \) if every coherent \( \delta \)-approximation exactly approximates some \( \delta \)-allowable permutation.
\end{definition}
\begin{proposition}[adding flexible litters]
  \uses{def:Inflexible,def:StrApprox}
  \label{prop:StrApprox.addFlexible}
  \lean{ConNF.StrApprox.addFlexible}
  \leanok
  Let \( \psi \) be a coherent \( \beta \)-approximation, and let \( L \) be \( A \)-flexible.
  Then there is a coherent extension \( \chi \geq \psi \) with \( L \in \coim \chi_A^\Litter \).
\end{proposition}
\begin{proof}
  \uses{prop:StrApprox.addOrbit}
  \leanok
  Define \( L' : \mathbb Z \to \Litter \) by \( L'(n) = L \), then appeal to \cref{prop:StrApprox.addOrbit} to obtain \( \chi \geq \psi \).
  All we must do is check that \( \psi \) is coherent at \( (L, L) \), which is trivial.
\end{proof}
\begin{proposition}[adding inflexible litters]
  \uses{def:FreedomOfAction,def:StrApprox}
  \label{prop:StrApprox.addInflexible}
  Let \( \psi \) be a coherent \( \beta \)-approximation, and let \( L \) be \( A \)-inflexible with path \( (\gamma, \delta, \varepsilon, B) \) and tangle \( t : \Tang_\delta \).
  Suppose that \( (\psi_B)_\delta \) is defined on all of \( \supp(t) \).\footnote{This is a nontrivial definition to make.}
  Suppose that freedom of action holds at level \( \delta \).
  Then there is a coherent extension \( \chi \geq \psi \) with \( L \in \coim \chi_A^\Litter \).
\end{proposition}
\begin{proof}
  \uses{prop:StrApprox.addOrbit,prop:StrApprox.Coherent.deriv,prop:StrApprox.Coherent.comp,prop:StrApprox.Coherent.inv}
  Let \( \rho \) be a \( \delta \)-allowable permutation that \( (\psi_B)_\delta \) approximates.
  Then for each \( n : \mathbb Z \), as \( (\psi^n_B)_\delta \) approximates \( \rho^n \), we obtain \( (\psi^n_B)_\delta(\supp(t)) = \rho^n(\supp(t)) \) as \( (\psi^n_B)_\delta \) is defined on all of \( \supp(t) \).\footnote{This should of course be its own lemma.}
  Define \( L : \mathbb Z \to \Litter \) by \( L(n) = f_{\delta,\varepsilon}(\rho^n(t)) \).

  Suppose that there is some \( n \) such that \( L(n) \in \coim \psi^\Litter \).
  Note that
  \begin{align*}
    (\psi^n_B)_\delta(\supp(t)) &= \rho^n(\supp(t)) \\
    \supp(t) &= (\psi^{-n}_B)_\delta(\rho^n(\supp(t))) \\
    \rho^{-n}(\rho^n(\supp(t))) &= (\psi^{-n}_B)_\delta(\supp(\rho^n(t)))
  \end{align*}
  So as \( \psi^{-n} \) is coherent, we obtain \( (L(n), f_{\delta,\varepsilon}(t)) \in (\psi^{-n}_A)^\Litter \).
  In particular, \( f_{\delta,\varepsilon}(t) \in \coim \psi_A^\Litter \) already, and no work needs to be done.

  We first check the hypothesis of \cref{prop:BaseApprox.addOrbit} for adding orbits.
  If \( f_{\delta,\varepsilon}(\rho^m(t)) = f_{\delta,\varepsilon}(\rho^n(t)) \), then \( \rho^m(t) = \rho^n(t) \), so \( \rho^{m+k}(t) = \rho^{n+k}(t) \), giving \( f_{\delta,\varepsilon}(\rho^{m+k}(t)) = f_{\delta,\varepsilon}(\rho^{n+k}(t)) \) as required.

  We now check the criterion of \cref{prop:StrApprox.addOrbit} for adding orbits coherently.
  It suffices to show that \( \psi \) is coherent at \( (L(n), L(n+1)) \) for each \( n : \mathbb Z \).
  This is witnessed by \( \rho \), which satisfies
  \[ (\psi_B)_\delta(\supp(\rho^n(t))) = \rho(\supp(\rho^n(t))) \]
  and
  \[ L(n) = f_{\delta,\varepsilon}(\rho^n(t));\quad L(n+1) = f_{\delta,\varepsilon}(\rho(\rho^n(t))) \]
  as required.\footnote{It might be helpful to abstract away the lemma \( (\psi^m_B)_\delta(\supp(\rho^n(t))) = \supp(\rho^{n+m}(t)) \) for the two places in the proof where this idea is used.}
\end{proof}
\begin{proposition}
  \uses{def:StrApprox.Coherent}
  \label{prop:StrApprox.chain}
  \lean{ConNF.StrApprox.exists_isMax}
  \leanok
  If \( (\psi_i)_{i : I} \) is a chain of coherent approximations where \( I \) is a linear order, then the supremum \( \psi \) is coherent.
\end{proposition}
\begin{proof}
  \leanok
  Direct, using the same idea as the proof of \cref{prop:StrApprox.addOrbit}.
\end{proof}
\begin{theorem}[freedom of action]
  \uses{def:FreedomOfAction}
  \label{thm:StrApprox.foa}
  \lean{ConNF.StrApprox.exists_exactlyApproximates}
  \leanok
  Freedom of action holds at all type indices \( \beta \leq \alpha \).
\end{theorem}
\begin{proof}
  \uses{prop:StrApprox.chain,prop:StrApprox.addFlexible,def:CoherentData,prop:BasePositions,prop:StrApprox.addInflexible}
  \leanok
  By induction, we may assume freedom of action holds at all \( \delta < \beta \).
  Let \( \psi \) be a coherent \( \beta \)-approximation, and let \( \chi \) be a maximal coherent extension, which exists by Zorn's lemma and \cref{prop:StrApprox.chain}.

  Suppose that there is a litter \( L \) such that there exists a path \( A \) where \( L \notin \coim \chi_A^\Litter \).
  Let \( L \) have minimal position with this property, and let \( A \) be such a path.

  Suppose that \( L \) is \( A \)-flexible.
  Then by \cref{prop:StrApprox.addFlexible}, there is an extension \( \varphi \) of \( \chi \) such that \( L \in \coim \varphi_A^\Litter \), contradicting maximality of \( \chi \).

  Suppose that \( L \) is \( A \)-inflexible, with path \( (\gamma,\delta,\varepsilon,B) \) and tangle \( t \).
  Then \( (\psi_B)_\delta \) is defined on all of \( \supp(t) \).
  Indeed, by \cref{def:CoherentData} (coherent data) and \cref{prop:fuzz} (fuzz maps), for each atom or near-litter \( y \) that appears in the range of \( \supp(t)_C \), we have \( \iota(y) < \iota(t) < \iota(L) \), giving the desired conclusion by minimality of the position of \( L \) and the criteria of \cref{prop:BasePositions}.
  Thus, we obtain the same contradiction by \cref{prop:StrApprox.addInflexible}.

  So \( \coim \chi_A^\Litter \) is the set of all litters for each path \( A \).
  We then use the fact that our model data is coherent to recursively compute the allowable permutation \( \rho \) with the same action as \( \chi \).
  Then \( \chi \) exactly approximates \( \rho \), so \( \psi \) also exactly approximates \( \rho \).\footnote{In general, if \( \psi \leq \chi \) and \( \chi \) (exactly) approximates \( \rho \) then \( \psi \) (exactly) approximates \( \rho \).}
\end{proof}

\section{Base actions}
\begin{definition}
  \uses{def:NearLitter}
  \label{def:Interference}
  \lean{ConNF.Interference}
  \leanok
  The \emph{interference} of near-litters \( N_1, N_2 \) is
  \[ \interf(N_1, N_2) = \begin{cases}
    N_1 \symmdiff N_2 & \text{if } N_1^\circ = N_2^\circ \\
    N_1 \cap N_2 & \text{if } N_1^\circ \neq N_2^\circ
  \end{cases} \]
  which is a small set of atoms.
\end{definition}
\begin{definition}
  \uses{def:Interference,def:BaseSupport}
  \label{def:BaseAction}
  \lean{ConNF.BaseAction}
  \leanok
  A \emph{base action} is a pair \( \xi = (\xi^\Atom, \xi^\NearLitter) \) such that \( \xi^\Atom \) and \( \xi^\NearLitter \) are relations of atoms and near-litters respectively (\cref{def:relation_props}), such that
  \begin{itemize}
    \item \( \xi^\Atom \) and \( \xi^\NearLitter \) are defined on small sets;
    \item \( \xi^\Atom \) is one-to-one;
    \item if \( (a_1, a_2) \in \xi^\Atom \) and \( (N_1, N_2) \in \xi^\NearLitter \), then \( a_1 \in N_1 \) if and only if \( a_2 \in N_2 \);
    \item if \( (N_1, N_3), (N_2, N_4) \in \xi^\NearLitter \), then \( N_1^\circ = N_2^\circ \) if and only if \( N_3^\circ = N_4^\circ \);
    \item for each \( (N_1, N_3), (N_2, N_4) \in \xi^\NearLitter \),
    \[ \interf(N_1, N_2) \subseteq \coim \xi^\Atom;\quad \interf(N_3, N_4) \subseteq \im \xi^\Atom \]
  \end{itemize}
  Note that these conditions imply that \( \xi^\NearLitter \) is one-to-one.
  We define the one-to-one relation \( \xi^\Litter \) by the constructor
  \[ (N_1, N_2) \in \xi^\NearLitter \to (N_1^\circ, N_2^\circ) \in \xi^\Litter \]

  The partial order on base actions is defined by \( \xi \leq \zeta \) if and only if \( \xi^\Atom \leq \zeta^\Atom \) and \( \xi^\NearLitter = \zeta^\NearLitter \).\footnote{We should make utilities for constructing extensions of base actions, reducing the proof obligations of showing that these are base actions (e.g.\ removing the last two bullet points and not needing to prove results we already know about \( \xi \)).}
  The inverse of \( \xi \) is \( ((\xi^\Atom)^{-1}, (\xi^\NearLitter)^{-1}) \).
  They act on base supports in the natural way.
\end{definition}
\begin{definition}
  \uses{def:BaseAction}
  \label{def:BaseAction.Nice}
  \lean{ConNF.BaseAction.Nice}
  \leanok
  A base action \( \xi \) is \emph{nice} if whenever \( (N_1, N_2) \in \xi^\NearLitter \),
  \[ N_1 \symmdiff \LS(N_1^\circ) \subseteq \coim \xi^\Atom;\quad N_2 \symmdiff \LS(N_2^\circ) \subseteq \im \xi^\Atom \]
\end{definition}
\begin{proposition}[extending orbits inside near-litters]
  \uses{def:BaseAction}
  \label{prop:BaseAction.exists_inside}
  \lean{ConNF.BaseAction.insideExtension}
  \leanok
  Every base action \( \xi \) admits an extension \( \zeta \) satisfying
  \[ \forall N \in \coim \xi^\NearLitter,\, N \setminus \LS(N^\circ) \subseteq \coim \xi^\Atom \]
\end{proposition}
\begin{proof}
  \leanok
  For each litter \( L \), there is an injection
  \[ i_L : \bigcup_{N \in \coim \xi^\NearLitter} (N \setminus \LS(N^\circ)) \to \{ a : \Atom \mid a^\circ = L \wedge \forall N \in \im \xi^\NearLitter,\, N^\circ = L \to a \in N \} \setminus \im \xi^\Atom \]
  by a cardinality argument.
  Define the relation \( R \) on atoms by the constructor
  \[ \forall (N_1, N_2) \in \xi^\NearLitter,\, \forall a \in N_1 \setminus \LS(N_1^\circ) \setminus \coim \xi^\Atom,\, (a, i_{N_2^\circ}(a)) \in R \]
  This is one-to-one and has disjoint image and coimage from \( \xi^\Atom \).

  We now show that if \( (a_1, a_2) \in R \) and \( (N_1, N_2) \in \xi^\NearLitter \), then \( a_1 \in N_1 \) if and only if \( a_2 \in N_2 \).
  Let \( (N_1, N_2), (N_1', N_2') \in \xi^\NearLitter \), and let \( a \in N_1 \setminus \LS(N_1^\circ) \setminus \coim \xi^\Atom \).
  Suppose that \( a \in N_1' \); we must show \( i_{N_2^\circ}(a) \in N_2' \).
  If \( N_1^\circ \neq {N_1'}^\circ \), then \( \interf(N_1, N_1') = N_1 \cap N_1' \), so \( a \in \interf(N_1, N_1') \subseteq \coim \xi^\Atom \), a contradiction.
  So \( N_1^\circ = {N_1'}^\circ \), giving \( N_2^\circ = {N_2'}^\circ \), so \( i_{N_2^\circ}(a) = i_{{N_2'}^\circ}(a) \in N_2' \) by definition.

  Conversely, suppose that \( i_{N_2^\circ}(a) \in N_2' \); we must show \( a \in N_1' \).
  Note that by definition, \( i_{N_2^\circ}(a) \in N_2 \).
  So if \( N_2^\circ \neq {N_2'}^\circ \), we would have \( i_{N_2^\circ}(a) \in N_2 \cap N_2' = \interf(N_2, N_2') \subseteq \im \xi^\Atom \), a contradiction.
  Hence \( N_2^\circ = {N_2'}^\circ \) and \( N_1^\circ = {N_1'}^\circ \).
  Thus, if \( a \notin N_1' \), we would have \( a \in N_1 \symmdiff N_1' = \interf(N_1, N_1') \subseteq \coim \xi^\Atom \), again a contradiction.

  Hence \( \zeta = (\xi^\Atom \sqcup R, \xi^\NearLitter) \) is a base action and satisfies the conclusion.
\end{proof}
\begin{proposition}[extending orbits outside near-litters]
  \uses{def:BaseAction}
  \label{prop:BaseAction.exists_outside}
  \lean{ConNF.BaseAction.outsideExtension}
  \leanok
  Every base action \( \xi \) admits an extension \( \zeta \) satisfying
  \[ \forall N \in \coim \xi^\NearLitter,\, \LS(N) \setminus N \subseteq \coim \xi^\Atom \]
\end{proposition}
\begin{proof}
  \leanok
  \uses{prop:BaseAction.exists_inside}
  Without loss of generality (as extensions are transitive), let \( \xi \) satisfy the conclusion of \cref{prop:BaseAction.exists_inside}.

  Let \( L \) be an arbitrary litter that whose litter set does not contain an atom in \( \im \xi^\Atom \) or \( \bigcup \im \xi^\NearLitter \).
  Define an injection
  \[ i : \bigcup_{N \in \coim \xi^\NearLitter} (\LS(N^\circ) \setminus N \setminus \coim \xi^\Atom) \to \LS(L) \]
  by a cardinality argument.
  Note that \( i \) has domain disjoint from \( \coim \xi^\Atom \) and image disjoint from \( \im \xi^\Atom \).

  We show that \( (\xi^\Atom \sqcup \graph i, \xi^\NearLitter) \) is a base action.
  It suffices to check that if \( (a_1, a_2) \in \graph i \) and \( (N_1, N_2) \in \xi^\NearLitter \), then \( a_1 \in N_1 \) if and only if \( a_2 \in N_2 \).
  As \( a_2 \in \LS(L) \), we have \( a_2 \notin N_2 \).
  Suppose that \( a_1 \in N_1 \).
  We know that there is a near-litter \( N \in \coim \xi^\NearLitter \) such that \( a_1 \in \LS(N^\circ) \setminus N \setminus \coim \xi^\Atom \).
  If \( N^\circ = N_1^\circ \), then \( a_1 \in N \symmdiff N_1 = \interf(N, N_1) \subseteq \coim \xi^\Atom \), a contradiction, hence \( a^\circ = N^\circ \neq N_1^\circ \).
  But then as \( \xi \) satisfies the conclusion of \cref{prop:BaseAction.exists_inside}, we have \( N_1 \setminus \LS(N_1^\circ) \subseteq \coim \xi^\Atom \), which again is a contradiction.
\end{proof}
\begin{proposition}
  \uses{def:BaseAction.Nice}
  \label{prop:BaseAction.exists_nice}
  \lean{ConNF.BaseAction.niceExtension}
  \leanok
  Every base action has a nice extension.
\end{proposition}
\begin{proof}
  \leanok
  \uses{prop:BaseAction.exists_outside,prop:BaseAction.exists_inside}
  Apply \cref{prop:BaseAction.exists_inside} to \( \xi \) to obtain \( \xi_1 \); apply \cref{prop:BaseAction.exists_inside} again to \( \xi_1^{-1} \) to obtain \( \xi_2 \); apply \cref{prop:BaseAction.exists_outside} to \( \xi_2 \) to obtain \( \xi_3 \), and finally apply \cref{prop:BaseAction.exists_outside} again to \( \xi_3^{-1} \) to obtain \( \xi_4 \), our target.
\end{proof}

\section{Structural actions}
\begin{definition}
  \uses{def:Tree,def:BaseAction,def:StrSupport}
  \label{def:StrAction}
  For a type index \( \beta \), a \emph{\( \beta \)-action} is a \( \beta \)-tree of base actions.
  We define an action of \( \beta \)-actions \( \xi \) on \( \beta \)-supports \( S \) by \( (\xi(S))_A = \xi_A(S_A) \).
\end{definition}
\begin{definition}
  \uses{def:StrAction,def:Inflexible}
  \label{def:StrAction.Coherent}
  A \( \beta \)-action \( \xi \) is \emph{coherent} at \( (A, L_1, L_2) \) if:
  \begin{itemize}
    \item If \( L_1 \) is \( A \)-inflexible with inflexible \( \beta \)-path \( I = (\gamma, \delta, \varepsilon, B) \) and tangle \( t : \Tang_\delta \), then there is some \( \delta \)-allowable permutation \( \rho \) such that
    \[ (\xi_B)_\delta(\supp(t)) = \rho(\supp(t)) \]
    and
    \[ L_2 = f_{\delta,\varepsilon}(\rho(t)) \]
    (and hence again every \( \delta \)-allowable \( \rho \) satisfying the hypothesis also satisfies the conclusion).
    \item If \( L_1 \) is \( A \)-flexible, then \( L_2 \) is \( A \)-flexible.
  \end{itemize}
  We say that \( \xi \) is \emph{coherent} if whenever \( (L_1, L_2) \in \xi_A^\Litter \), \( \xi \) is coherent at \( (A, L_1, L_2) \).
\end{definition}
\begin{definition}
  \uses{def:StrAction,def:StrApprox.Coherent}
  \label{def:FlexApprox}
  \lean{ConNF.BaseAction.FlexApprox}
  \leanok
  Let \( A : \beta \tpath \bot \).
  An \emph{\( A \)-flexible approximation} of a base action \( \xi \) is a base approximation \( \psi \) such that
  \begin{enumerate}
    \item \( \xi^\Atom \leq \psi^{E\Atom} \);
    \item if \( L \in \coim \psi^\Litter \), then \( L \) is \( A \)-flexible;
    \item if \( (N_1, N_2) \in \xi^\NearLitter \) and \( N_1^\circ \) is \( A \)-flexible, then \( (N_1^\circ, N_2^\circ) \in \psi^\Litter \);
    \item if \( (N_1, N_2) \in \xi^\NearLitter \), then \( N_1 \symmdiff \LS(N_1^\circ) \subseteq \coim \psi^\Atom \) and \( N_2 \symmdiff \LS(N_2^\circ) \subseteq \coim \psi^\Atom \);
    \item if \( (N_1, N_2) \in \xi^\NearLitter \), then for each atom \( a_2 \),
    \[ a_2 \in N_2 \leftrightarrow (\exists a_1 \in N_1,\, (a_1, a_2) \in \psi^{E\Atom}) \vee (a_2 \notin \coim \psi^{E\Atom} \wedge a_2^\circ = N_2^\circ) \]
  \end{enumerate}
  A \emph{flexible approximation} of a \( \beta \)-action \( \xi \) is a \( \beta \)-approximation \( \psi \) such that for each \( A : \beta \tpath \bot \), the base approximation \( \psi_A \) is an \( A \)-flexible approximation of \( \xi_A \).
  Flexible approximations are coherent.
\end{definition}
\begin{proposition}
  \uses{def:FlexApprox}
  \label{prop:exists_flexApprox}
  \lean{ConNF.BaseAction.flexApprox_flexApprox}
  \leanok
  Every base action has an \( A \)-flexible approximation.
  Hence, every \( \beta \)-action has a flexible approximation, which can be computed branchwise.
\end{proposition}
\begin{proof}
  \leanok
  \uses{prop:BaseAction.exists_nice,prop:completing_orbits,prop:completing_restricted_orbits}
  If \( \xi \leq \zeta \) and \( \psi \) is an \( A \)-flexible approximation for \( \zeta \), then \( \psi \) is an \( A \)-flexible approximation for \( \xi \).
  So it suffices to prove the result for nice base actions \( \xi \) by \cref{prop:BaseAction.exists_nice}.

  Define the permutative relation \( R : \Litter \to \Litter \to \Prop \) to be a permutative extension of \( \xi^\Litter \), which exists by \cref{prop:completing_orbits}.
  Let \( \pi \) be the permutation of litters defined by \( R \), or the identity on any litter not in \( \coim R \).

  Define an orbit restriction \( (t, f, \pi) \) (\cref{def:OrbitRestriction}) for \( \field \xi^\Atom \) by
  \[ u = \{ a : \Atom \mid \forall N \in \field \xi^\NearLitter,\, N^\circ = a^\circ \to a \in N \};\quad t = u \setminus \field \xi^\Atom \]
  with function \( f : \Atom \to \Litter \) defined by \( f(a) = a^\circ \), and litter permutation \( \pi \).
  We must check that for each litter \( L \), the set \( t \cap \LS(L) \) has cardinality at least \( \max(\aleph_0, \#\field \xi^\Atom) \).
  But we can write
  \[ t \cap \LS(L) = \LS(L) \setminus \left( \field \xi^\Atom \cup \bigcup_{N \in \field \xi^\NearLitter,\, N^\circ = L} (\LS(L) \setminus N) \right) \]
  where the set being removed from \( \LS(L) \) is small, so \( t \cap \LS(L) \) is a large set, and \( \aleph_0 \) and \( \#\field \xi^\Atom \) are less than \( \#\kappa \), as required.
  Then by \cref{prop:completing_restricted_orbits}, there is a permutative relation \( S \geq \xi^\Atom \) defined on a small set and contained in \( \field \xi^\Atom \cup t = \field \xi^\Atom \cup u \), such that if
  \[ (a_1, a_2) \in S \to (a_1, a_2) \in \xi^\Atom \vee \pi(a_1^\circ) = a_2^\circ \]

  Let \( T \) be a permutative extension of the restriction of \( \xi^\Litter \) to the \( A \)-flexible litters, with coimage contained entirely in the set of \( A \)-flexible litters, given by \cref{prop:completing_orbits}.
  From this, we define a base approximation \( \psi = (S, T) \).

  It remains to check that \( \psi \) is an \( A \)-flexible approximation of \( \xi \).
  Conditions 1--3 are trivial, and condition 4 follows from the fact that we assumed \( \xi \) was nice.

  We first show an auxiliary result.
  Let \( (N_1, N_2) \in \xi^\NearLitter \), and let \( (a_1, a_2) \in S \); we will show that \( a_1 \in N_1 \leftrightarrow a_2 \in N_2 \).
  Suppose first that \( (a_1, a_2) \in \xi^\Atom \), in which case we are done as \( \xi \) is a base action.
  Instead, we have \( a_1 \notin \coim \xi^\Atom, a_2 \notin \im \xi^\Atom \) and \( \pi(a_1^\circ) = a_2^\circ \).
  As \( \xi \) is nice, we must have \( a_1 \in N_1 \leftrightarrow a_1^\circ = N_1^\circ \).
  Similarly, \( a_2 \in N_2 \leftrightarrow a_2^\circ = N_2^\circ \).
  So if \( a_1 \in N_1 \), we conclude that \( a_2^\circ = \pi(a_1^\circ) = \pi(N_1^\circ) = N_2^\circ \) giving \( a_2 \in N_2 \), and if \( a_2 \in N_2 \), we find \( \pi(a_1^\circ) = a_2^\circ = N_2^\circ \) so \( a_1^\circ = N_1^\circ \), giving \( a_1 \in N_1 \).

  We now prove condition 5, which is the equation
  \[ a_2 \in N_2 \leftrightarrow (\exists a_1 \in N_1,\, (a_1, a_2) \in S) \vee (a_2 \notin \coim S \wedge a_2^\circ = N_2^\circ) \]
  where \( (N_1, N_2) \in \xi^\NearLitter \).
  Consider the first the case where \( (a_1, a_2) \in S \) and \( a_1 \in N_1 \).
  The auxiliary lemma shows that \( a_2 \in N_2 \) as required.
  Now consider the case where \( a_2 \notin \coim S \) and \( a_2^\circ = N_2^\circ \).
  If \( a_2 \notin N_2 \), then \( a_2 \in N_2 \symmdiff \LS(N_2^\circ) \subseteq \im \xi^\Atom \), a contradiction.
  Finally suppose that neither holds, so
  \[ (\forall a_1,\, (a_1, a_2) \in S \to a_1 \notin N_1) \wedge (a_2 \in \coim S \vee a_2^\circ \neq N_2^\circ) \]
  If \( a_2 \in \coim S \), then there is \( a_1 \) such that \( (a_1, a_2) \in S \), and we have \( a_1 \notin N_1 \), giving \( a_2 \notin N_2 \) by the auxiliary lemma.
  Finally, if \( a_2 \notin \coim S \) and \( a_2^\circ \neq N_2^\circ \), then \( a_2 \notin N_2 \), since \( a_2 \in N_2 \) would imply \( a_2 \in N_2 \symmdiff \LS(N_2^\circ) \), contradicting the fact that \( \xi \) is nice.
\end{proof}
\begin{definition}[approximates]
  \uses{def:StrAction,def:ModelData}
  \label{def:StrAction.Approximates}
  We say that a \( \beta \)-action \( \xi \) \emph{approximates} a \( \beta \)-allowable permutation \( \rho \) if \( \xi_A^\NearLitter \leq \rho_A^\NearLitter \) and \( \xi_A^\Atom \leq \rho_A^\Atom \) for each path \( A : \beta \tpath \bot \).\footnote{Again, we should define what it means for a base action to approximate a near-litter permutation, and define this in terms of that.}
\end{definition}
\begin{proposition}
  \uses{def:FlexApprox,def:StrApprox.Approximates,def:StrAction.Approximates}
  \label{prop:FlexApprox.smul_nearLitter_eq}
  \lean{ConNF.BaseAction.smul_nearLitter_of_smul_litter}
  \leanok
  Let \( \xi \) be a base action, and let \( \psi \) be an \( A \)-flexible approximation of it.
  Let \( \pi \) be a base permutation that \( \psi \) exactly approximates.
  If \( (N_1, N_2) \in \xi^\NearLitter \) and \( \pi(N_1^\circ) = N_2^\circ \), then \( \pi(N_1) = N_2 \).
\end{proposition}
\begin{proof}
  \leanok
  First, note that
  \begin{align*}
    \pi[N_1] &= \pi[\LS(N_1^\circ)] \symmdiff \pi[N_1 \symmdiff \LS(N_1^\circ)] \\
    &= (\pi[\LS(N_1^\circ) \cap \coim \psi^{E\Atom}] \cup \pi[\LS(N_1^\circ) \setminus \coim \psi^{E\Atom}]) \symmdiff \pi[N_1 \symmdiff \LS(N_1^\circ)]
  \end{align*}
  As \( \psi \) exactly approximates \( \pi \) and \( \pi(N_1^\circ) = N_2^\circ \), we have the equation
  \[ \pi[\LS(N_1^\circ) \setminus \coim \psi^{E\Atom}] = \LS(N_2^\circ) \setminus \coim \psi^{E\Atom} \]
  Combining this with the fact that \( \psi^{E\Atom} \leq \pi^\Atom \), and that \( N_1 \symmdiff \LS(N_1^\circ) \subseteq \coim \psi^{E\Atom} \), we obtain
  \begin{align*}
    \pi[N_1]
    &= (\im \psi^{E\Atom}|_{\LS(N_1^\circ) \cap \coim \psi^{E\Atom}} \cup (\LS(N_2^\circ) \setminus \coim \psi^{E\Atom})) \symmdiff \im \psi^{E\Atom}|_{N_1 \symmdiff \LS(N_1^\circ)} \\
    &= (\im \psi^{E\Atom}|_{\LS(N_1^\circ) \cap \coim \psi^{E\Atom}} \symmdiff \im \psi^{E\Atom}|_{N_1 \symmdiff \LS(N_1^\circ)})  \cup (\LS(N_2^\circ) \setminus \coim \psi^{E\Atom}) \\
    &= \im \psi^{E\Atom}|_{(\LS(N_1^\circ) \cap \coim \psi^{E\Atom}) \symmdiff (N_1 \symmdiff \LS(N_1^\circ))} \cup (\LS(N_2^\circ) \setminus \coim \psi^{E\Atom}) \\
    &= \im \psi^{E\Atom}|_{N_1 \cap \coim \psi^{E\Atom}} \cup (\LS(N_2^\circ) \setminus \coim \psi^{E\Atom})
  \end{align*}
  which is equal to \( N_2 \) by part of \cref{def:FlexApprox}.
\end{proof}
\begin{proposition}
  \uses{def:StrApprox.Coherent,def:FlexApprox,def:StrApprox.Approximates,def:StrAction.Approximates}
  \label{prop:approximates_of_flexApprox}
  \lean{ConNF.StrAction.approximates_of_flexApprox_exactlyApproximates}
  \leanok
  Let \( \xi \) be a coherent \( \beta \)-action, and let \( \psi \) be a flexible approximation for it.
  If \( \psi \) exactly approximates some allowable permutation \( \rho \), then \( \xi \) approximates \( \rho \).
\end{proposition}
\begin{proof}
  \uses{prop:FlexApprox.smul_nearLitter_eq}
  \leanok
  First, note that \( \xi_A^\Atom \leq \psi_A^{E\Atom} \) and \( \psi_A^\Atom \leq \rho_A^\Atom \) give the required result for atoms.
  Now suppose that \( (N_1, N_2) \in \xi_A^\NearLitter \); we must show that \( \rho_A(N_1) = N_2 \).
  We prove this by induction on \( \iota(N_1) \), generalising over all \( A \).

  By \cref{prop:FlexApprox.smul_nearLitter_eq}, it suffices to show that \( \rho_A(N_1^\circ) = N_2^\circ \).
  Suppose that \( N_1^\circ \) is \( A \)-flexible.
  Then by \cref{def:FlexApprox}, \( (N_1^\circ, N_2^\circ) \in \psi_A^\Litter \).
  Hence \( \rho_A(N_1^\circ) = N_2^\circ \) as required.

  Suppose not, so \( N_1^\circ \) is \( A \)-inflexible with path \( (\gamma,\delta,\varepsilon,B) \) and tangle \( t : \Tang_\delta \).
  By coherence of \( \xi \), we know that \( (\xi_B)_\delta \) is defined on \( \supp(t) \), and it suffices to show that
  \[ (\xi_B)_\delta(\supp(t)) = (\rho_B)_\delta(\supp(t)) \]
  Let \( C : \delta \tpath \bot \) and \( a \) be an atom such that \( (i, a) \in \supp(t)_C^\Atom \) for some \( i \).
  Then \( (a, ((\rho_B)_\delta)_C(a)) \in ((\xi_B)_\delta)_C^\Atom \) by the result for atoms.
  Now suppose \( N \) is a near-litter such that \( (i, N) \in \supp(t)_C^\NearLitter \).
  Then
  \[ \iota(N) < \iota(t) < \iota(f_{\delta,\varepsilon}(t)) = \iota(N_1^\circ) \]
  So we may apply the inductive hypothesis, giving \( (N, ((\rho_B)_\delta)_C(N)) \in ((\xi_B)_\delta)_C^\NearLitter \) as required.
\end{proof}
\begin{theorem}[freedom of action for actions]
  \uses{def:StrAction.Coherent,def:StrAction.Approximates}
  \label{thm:StrAction.foa}
  \lean{ConNF.StrAction.freedomOfAction}
  \leanok
  Every coherent action approximates some allowable permutation.
\end{theorem}
\begin{proof}
  \leanok
  \uses{prop:exists_flexApprox,prop:approximates_of_flexApprox,thm:StrApprox.foa}
  Let \( \xi \) be a coherent \( \beta \)-action, and let \( \psi \) be a flexible approximation for it, which exists by \cref{prop:exists_flexApprox}.
  Then apply \cref{thm:StrApprox.foa} (freedom of action) to \( \psi \) to obtain a \( \beta \)-allowable permutation \( \rho \) that \( \psi \) exactly approximates.
  Finally, appeal to \cref{prop:approximates_of_flexApprox} to conclude that \( \xi \) approximates \( \rho \).
\end{proof}
